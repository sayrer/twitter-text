# Java FFM (Panama) Bindings for twitter-text

This directory contains Java 22+ bindings using the Foreign Function & Memory API (Project Panama).

## Architecture

1. **C Header** (`include/twitter_text_c.h`)
   - Defines C-compatible API
   - Used by `jextract` to generate Java bindings

2. **Rust FFI** (`src/lib.rs`)
   - Implements C ABI functions with `#[no_mangle]` and `extern "C"`
   - Builds as `cdylib` (shared library)

3. **Java Bindings** (generated by `jextract`)
   - `jextract` reads the C header and generates Java code
   - Uses `MemorySegment`, `SegmentAllocator`, etc. from `java.lang.foreign`

4. **Java Wrapper** (TODO - to be implemented)
   - High-level Java API wrapping the low-level FFM bindings
   - Similar to Python/Ruby bindings

## Build Steps

### 1. Build Rust Library

```bash
bazel build //rust/java-bindings:twitter_text_java_ffm
```

### 2. Generate Java Bindings with jextract

```bash
# Install jextract from https://jdk.java.net/jextract/
jextract \
  --source \
  -t com.twitter.twittertext.ffi \
  -l twitter_text_java_ffm \
  include/twitter_text_c.h
```

This generates Java source files in the `com.twitter.twittertext.ffi` package.

### 3. Create Java Wrapper Classes

Create high-level wrapper classes like:
- `TwitterTextConfiguration.java`
- `TwitterTextValidator.java`
- `TwitterTextAutolinker.java`
- `TwitterTextExtractor.java`

Example:

```java
package com.twitter.twittertext;

import com.twitter.twittertext.ffi.*;
import java.lang.foreign.*;

public class TwitterTextValidator implements AutoCloseable {
    private final MemorySegment validator;
    private final SegmentAllocator allocator;
    
    public TwitterTextValidator(TwitterTextConfiguration config) {
        this.allocator = Arena.ofAuto();
        this.validator = twitter_text_c.twitter_text_validator_new(
            config.getNativeHandle()
        );
    }
    
    public boolean isValidTweet(String text) {
        try (Arena arena = Arena.ofConfined()) {
            MemorySegment textSegment = arena.allocateUtf8String(text);
            return twitter_text_c.twitter_text_validator_is_valid_tweet(
                validator,
                textSegment
            );
        }
    }
    
    @Override
    public void close() {
        twitter_text_c.twitter_text_validator_free(validator);
    }
}
```

### 4. Write Tests

Create JUnit tests similar to the existing test structure.

## TODO

- [ ] Add `BUILD.bazel` rules for:
  - Building Rust cdylib
  - Running jextract
  - Compiling Java code
  - Running tests
- [ ] Implement remaining Extractor functions (extract_urls, extract_hashtags, etc.)
  - Consider returning JSON strings for complex return types
- [ ] Create high-level Java wrapper classes
- [ ] Write JUnit tests
- [ ] Add documentation

## References

- Java FFM API: https://openjdk.org/jeps/454
- jextract tool: https://jdk.java.net/jextract/
- Tutorial: https://akilmohideen.github.io/java-rust-bindings-manual/title.html
